# Compose v2에서는 version 키 생략 권장

services:
  # --- Spring Boot (백엔드) ---
  spring:
    build: ./spring
    container_name: prham-spring
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE:-mymm_db}?useSSL=false&serverTimezone=Asia/Seoul
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER:-prham_user}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD:-prham_password}
    expose:
      - '8080'
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'wget -qO- http://localhost:8080/actuator/health | grep -q ''"status":"UP"'' || exit 1',
        ]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: always
    networks: [prham-network]

  # --- Nginx (정적 프론트 + /api 프록시) ---
  nginx:
    build: ./nginx
    container_name: prham-nginx
    ports:
      - '80:80' # 우선 HTTP만 오픈(SSL은 나중에 443 추가)
      # - "443:443"  # SSL 적용할 때 열기
    depends_on:
      spring:
        condition: service_healthy
    restart: always
    networks: [prham-network]
    # SSL 쓰면 인증서 마운트
    # volumes:
    #   - ./ssl:/etc/letsencrypt:ro

  # --- MySQL ---
  mysql:
    image: mysql:${MYSQL_VERSION:-8.0}
    container_name: prham-mysql
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --lower_case_table_names=2
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mymm_db}
      MYSQL_USER: ${MYSQL_USER:-prham_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-prham_password}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
      TZ: Asia/Seoul
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - '${MYSQL_HOST_PORT:-3306}:3306'
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'mysqladmin ping -h localhost -uroot -p$${MYSQL_ROOT_PASSWORD} --silent',
        ]
      interval: 10s
      timeout: 5s
      retries: 10
    restart: always
    networks: [prham-network]

  # --- MongoDB (필요 시) ---
  mongodb:
    image: mongo:${MONGO_VERSION:-7.0}
    container_name: prham-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-admin_password}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-prham_db}
      TZ: Asia/Seoul
    volumes:
      - mongodb-data:/data/db
    ports:
      - '${MONGO_HOST_PORT:-27017}:27017'
    restart: always
    networks: [prham-network]

volumes:
  mysql-data:
  mongodb-data:

networks:
  prham-network:
    driver: bridge
